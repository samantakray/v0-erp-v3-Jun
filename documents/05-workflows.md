# Workflows

## Overview

The Jewelry ERP application implements several key workflows to manage the jewelry manufacturing process, from order creation to job completion. This document describes these workflows, reflecting the current system architecture which heavily utilizes centralized UI components like the `NewOrderSheet` for order creation and the `JobDetailSheet` for managing individual job progression. Server actions in `app/actions/order-actions.ts` and `app/actions/job-actions.ts` underpin these state transitions.

## Order Management Workflow

The order management workflow begins with creating a new order and culminates in the automatic generation of jobs for each item in the order.

### Order Creation Process

The primary interface for creating new orders is the `components/new-order-sheet.tsx`.

1.  **Initiation:** User clicks a "New Order" button, launching the `NewOrderSheet`.
2.  **Order ID Prediction:** The UI displays a predicted next available order ID (e.g., `O-XXXX`), fetched via the `getPredictedNextOrderNumber` server action. The final ID is confirmed upon saving.
3.  **Order Type Selection:**
    *   **Customer Order:** User selects an existing customer or can create a new one.
    *   **Stock Order:** A default customer is typically assigned.
4.  **Customer Details:** Customer name and ID are recorded.
5.  **Date Management:**
    *   **Production Date:** Can be set globally for the order.
    *   **Delivery Date:** Can be set globally for the order.
    *   Individual SKUs within the order can also have their own specific production and delivery dates, overriding the global dates if necessary.
6.  **SKU Addition:**
    *   **Select Existing SKUs:** Users can search and select from a list of existing SKUs. Quantity for each SKU is specified.
    *   **Bulk Assign SKUs:** A feature allows adding multiple SKUs and their quantities using a comma-separated format (e.g., "SKU-001:2, SKU-002:1").
    *   **Create New SKU:** If a required SKU doesn't exist, users can initiate the creation of a new SKU directly from the order sheet, which typically opens the `components/new-sku-sheet.tsx` for detailed SKU information input.
    *   **Per-SKU Remarks:** Specific remarks or instructions can be added to each SKU line item.
7.  **Order Remarks:** General remarks or special instructions for the entire order can be added.
8.  **Saving the Order:**
    *   **Save as Draft:** The order can be saved with a "Draft" status, allowing for later modifications without generating jobs.
    *   **Submit Order:** When saved with a status other than "Draft" (e.g., "New" or "Pending"), the `createOrder` server action in `app/actions/order-actions.ts` is invoked.
9.  **Automatic Job Generation:**
    *   Upon successful submission of a non-draft order, the system automatically creates individual jobs.
    *   One job is created for *each unit* of *each SKU* listed in the order.
    *   **Job ID Generation:** Jobs are assigned an ID in the format `J{OrderNumericPart}-{ItemSequence}` (e.g., if Order ID is `O-1050`, jobs could be `J1050-1`, `J1050-2`). This ID is generated by the application logic within the `createOrder` server action.
    *   **Initial Job State:** Newly created jobs are set to `status: JOB_STATUS.NEW` and `current_phase: JOB_PHASE.STONE` as defined in `constants/job-workflow.ts`.
    *   An initial entry is made in the `job_history` table for each new job.

## Job Workflow

Each job progresses through a series of defined phases and statuses, primarily managed via the `components/job-detail-sheet.tsx`. This component provides a tabbed interface for users to perform actions related to the job's current phase. The `app/actions/job-actions.ts` (`updateJobPhase` function) handles the backend logic for status and phase transitions.

\`\`\`mermaid
stateDiagram-v2
    direction LR
    [*] --> NEW_JOB : Create Job
    NEW_JOB --> BAG_CREATED : Bag Creation Task
    BAG_CREATED --> STONE_SELECTED : Stone Selection Complete
    STONE_SELECTED --> DIAMOND_SELECTED : Diamond Selection Complete
    DIAMOND_SELECTED --> SENT_TO_MANUFACTURER : Manufacturer Assigned
    SENT_TO_MANUFACTURER --> IN_PRODUCTION : (External/Manual Update)
    IN_PRODUCTION --> RECEIVED_FROM_MANUFACTURER : (External/Manual Update)
    RECEIVED_FROM_MANUFACTURER --> QC_PROCESSING : QC Initiated
    QC_PROCESSING --> QC_PASSED : QC Passed
    QC_PROCESSING --> QC_FAILED : QC Failed
    QC_FAILED --> SENT_TO_MANUFACTURER : Rework (Phase back to Manufacturer)
    QC_PASSED --> COMPLETED : Job Marked Complete
    COMPLETED --> [*]

    state NEW_JOB: New
    state BAG_CREATED: Bag Created
    state STONE_SELECTED: Stone Selected
    state DIAMOND_SELECTED: Diamond Selected
    state SENT_TO_MANUFACTURER: Sent to Manufacturer
    state IN_PRODUCTION: In Production
    state RECEIVED_FROM_MANUFACTURER: Received from Manufacturer
    state QC_PROCESSING: Quality Check
    state QC_PASSED: QC Passed
    state QC_FAILED: QC Failed
\`\`\`
*Note on `In Production` and `Received from Manufacturer` statuses: While the `JobDetailSheet` UI transitions to the Quality Check phase after manufacturer assignment, the job's status may be updated to `In Production` and subsequently `Received from Manufacturer` through external means or manual updates by relevant personnel. The `NextTaskModule` often uses `In Production` to flag jobs for the QC team's attention.*

### Job Phases & Actions (within `JobDetailSheet`)

The `JobDetailSheet` component is the central UI for managing a job's lifecycle. It uses tabs corresponding to `JOB_PHASE` constants.

1.  **Bag Creation (Implicit First Step for `JOB_STATUS.NEW`)**
    *   **Responsibility:** Typically the "Bagging Team".
    *   **Action:** Physically create a bag for materials for the job. The system may have a separate interface or process for this team to update the job status.
    *   **System Update:** Job status transitions from `JOB_STATUS.NEW` to `JOB_STATUS.BAG_CREATED`. The `current_phase` for the job becomes `JOB_PHASE.STONE`.
    *   **Next Step:** Stone Selection.

2.  **Stone Selection (`JOB_PHASE.STONE`)**
    *   **Interface:** "Stone" tab in `JobDetailSheet`.
    *   **Process:**
        1.  Users view available stone lots (fetched via `fetchStoneLots`).
        2.  Allocate specific stone lots to the job using `StoneAllocationRow` components.
        3.  Specify quantity and weight for each allocated lot.
        4.  The system validates allocations against available lot quantities.
    *   **Action:** User clicks "Complete Stone Selection". This triggers the `updateJobPhase` server action with stone allocation data.
    *   **Result:**
        *   `job.status` becomes `JOB_STATUS.STONE_SELECTED`.
        *   `job.current_phase` becomes `JOB_PHASE.DIAMOND`.
    *   **Sticker Preview:** Data includes total stones, total weight, and list of allocated lot numbers.

3.  **Diamond Selection (`JOB_PHASE.DIAMOND`)**
    *   **Interface:** "Diamond" tab in `JobDetailSheet`.
    *   **Process:**
        1.  Users view available diamond lots (fetched via `fetchDiamondLots`).
        2.  Allocate specific diamond lots using `DiamondAllocationRow` components.
        3.  Specify quantity and weight (carats). Lot details like size, shape, and quality may auto-fill.
        4.  Validation against available lot quantities.
    *   **Action:** User clicks "Complete Diamond Selection". Triggers `updateJobPhase` with diamond allocation data.
    *   **Result:**
        *   `job.status` becomes `JOB_STATUS.DIAMOND_SELECTED`.
        *   `job.current_phase` becomes `JOB_PHASE.MANUFACTURER`.
    *   **Sticker Preview:** Data includes total diamonds, total weight, and list of allocated lot numbers.

4.  **Manufacturer Assignment (`JOB_PHASE.MANUFACTURER`)**
    *   **Interface:** "Manufacturer" tab in `JobDetailSheet`.
    *   **Process:**
        1.  User selects a manufacturer from a list.
        2.  User sets an expected completion date.
    *   **Action:** User clicks "Assign Manufacturer". Triggers `updateJobPhase` with manufacturer details.
    *   **Result:**
        *   `job.status` becomes `JOB_STATUS.SENT_TO_MANUFACTURER`.
        *   `job.current_phase` becomes `JOB_PHASE.QUALITY_CHECK`.
    *   **Sticker Preview:** Data includes selected manufacturer name and expected completion date.
    *   *(The job is now with the manufacturer. Its status may be updated externally to `IN_PRODUCTION` and then `RECEIVED_FROM_MANUFACTURER`.)*

5.  **Quality Check (`JOB_PHASE.QUALITY_CHECK`)**
    *   **Interface:** "QC" tab in `JobDetailSheet`. This tab becomes active/relevant once the job is in the `QUALITY_CHECK` phase (e.g., status is `RECEIVED_FROM_MANUFACTURER`).
    *   **Process:**
        1.  User enters the measured weight of the item.
        2.  User adds any quality check notes.
        3.  User marks the QC as "Passed" or "Failed".
    *   **Action:** User clicks "Pass QC" or "Fail QC". Triggers `updateJobPhase` with QC data.
    *   **Result (Pass):**
        *   `job.status` becomes `JOB_STATUS.QC_PASSED`.
        *   `job.current_phase` becomes `JOB_PHASE.COMPLETE`.
    *   **Result (Fail):**
        *   `job.status` becomes `JOB_STATUS.QC_FAILED`.
        *   `job.current_phase` becomes `JOB_PHASE.MANUFACTURER` (to initiate rework).
    *   **Sticker Preview:** Data includes QC result (Passed/Failed), measured weight, and notes.

6.  **Job Completion (`JOB_PHASE.COMPLETE`)**
    *   **Interface:** "Complete" tab in `JobDetailSheet`, which often shows a summary of all previous phase data.
    *   **Process:** User verifies all details and confirms job completion.
    *   **Action:** User clicks "Mark Job as Complete" (or similar). Triggers `updateJobPhase`.
    *   **Result:**
        *   `job.status` becomes `JOB_STATUS.COMPLETED`.
        *   `job.current_phase` remains `JOB_PHASE.COMPLETE`.
    *   **Sticker Preview:** Data includes completion date and final status.

## Team Task Management and Workflow Guidance

The system uses specific components to help teams identify and process their pending tasks, rather than relying on static individual team workflow pages.

1.  **`components/next-task-module.tsx` (Next Task Module):**
    *   This component provides a dynamic "Next Job" suggestion for different operational teams.
    *   It filters and sorts jobs based on their current status and due dates to guide users to the most pressing task for their team.
    *   **Team-to-Job Status Mapping for Task Assignment:**
        *   **Bagging Team:** Looks for jobs with `status: JOB_STATUS.NEW`.
        *   **Stone Selection Team:** Looks for jobs with `status: JOB_STATUS.BAG_CREATED`.
        *   **Diamond Selection Team:** Looks for jobs with `status: JOB_STATUS.STONE_SELECTED`.
        *   **Manufacturer Assignment Team:** Looks for jobs with `status: JOB_STATUS.DIAMOND_SELECTED`.
        *   **Quality Control (QC) Team:** Looks for jobs with `status: JOB_STATUS.IN_PRODUCTION` (or `RECEIVED_FROM_MANUFACTURER` depending on exact alerting logic).

2.  **`components/job-detail-sheet.tsx` (Job Detail Sheet):**
    *   Once a job is selected (often via the `NextTaskModule` or a jobs list), the `JobDetailSheet` is the central interface for performing all actions related to the job's current phase.
    *   Its tabbed navigation directly corresponds to the `JOB_PHASE` constants (`STONE`, `DIAMOND`, `MANUFACTURER`, `QC`, `COMPLETE`), ensuring users are presented with the correct interface and actions for the job's current stage.

## Job Status and Phase Transitions

The `updateJobPhase` server action in `app/actions/job-actions.ts` is the primary mechanism for transitioning a job's status and current phase. The `JobDetailSheet` UI calls this action.

| Triggering UI Phase (`JOB_PHASE` in `JobDetailSheet`) | Action in `JobDetailSheet`     | Key Data Sent to Server Action | Resulting `job.status` (`JOB_STATUS`) | Resulting `job.current_phase` (`JOB_PHASE`) |
| :---------------------------------------------------- | :----------------------------- | :----------------------------- | :------------------------------------ | :------------------------------------------ |
| (Bag Creation - handled by Bag Team)                  | (Task Completion by Bag Team)  | Bag Tag Info (if any)          | `BAG_CREATED`                         | `STONE`                                     |
| `STONE`                                               | Complete Stone Selection       | Stone allocations, totals      | `STONE_SELECTED`                      | `DIAMOND`                                   |
| `DIAMOND`                                             | Complete Diamond Selection     | Diamond allocations, totals    | `DIAMOND_SELECTED`                    | `MANUFACTURER`                              |
| `MANUFACTURER`                                        | Assign Manufacturer            | Manufacturer, expected date    | `SENT_TO_MANUFACTURER`                | `QUALITY_CHECK`                             |
| `QUALITY_CHECK`                                       | Pass QC                        | QC data (weight, notes, passed=true) | `QC_PASSED`                           | `COMPLETE`                                  |
| `QUALITY_CHECK`                                       | Fail QC                        | QC data (weight, notes, passed=false)| `QC_FAILED`                           | `MANUFACTURER` (for rework)                 |
| `COMPLETE`                                            | Mark Job as Complete           | Completion timestamp           | `COMPLETED`                           | `COMPLETE`                                  |

*Note: The transition from `SENT_TO_MANUFACTURER` to `IN_PRODUCTION` and then to `RECEIVED_FROM_MANUFACTURER` is typically handled outside the direct user actions within `JobDetailSheet`'s phase completion buttons. These statuses may be updated by manufacturer interactions or administrative actions.*
