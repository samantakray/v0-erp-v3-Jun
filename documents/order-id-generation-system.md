# Order ID Generation System

## Overview

The Order ID Generation System is responsible for creating unique, sequential identifiers for orders in the Jewellery ERP system. The system uses a prediction-based approach to display the next available order ID to users without consuming the ID until an order is actually created.

## Order ID Format

Order IDs follow a standardized format:

- Format: `O-XXXX`
- Example: `O-0001`, `O-0002`, etc.
- The prefix "O-" indicates an order
- The numeric portion is sequential and padded with leading zeros to ensure consistent formatting

## Prediction-Based Approach

The system uses a prediction-based approach to prevent gaps in order numbering:

1. When a user opens the "Create New Order" form, the system predicts the next available order ID by querying the database for the most recent order and incrementing its ID
2. The predicted ID is displayed to the user in the form
3. If the user closes the form without creating an order, the ID is not consumed
4. When an order is actually created, the database generates the official order ID (which should match the prediction if no other orders were created in the meantime)

This approach provides a better user experience by showing the expected order ID upfront while preventing gaps in the sequence that would occur if IDs were reserved but not used.

## Technical Implementation

### Server-Side Implementation

The prediction logic is implemented in a server action called `getPredictedNextOrderNumber()` in `app/actions/order-actions.ts`:

\`\`\`typescript
export async function getPredictedNextOrderNumber() {
  // Create Supabase client
  const supabase = createServiceClient()

  try {
    // Fetch the most recent order from Supabase
    const { data, error } = await supabase
      .from("orders")
      .select("order_id")
      .order("created_at", { ascending: false })
      .limit(1)

    // If no orders exist, return a default starting number
    if (!data || data.length === 0) {
      return {
        success: true,
        predictedOrderId: "O-0001",
      }
    }

    // Extract the numerical part (assuming format O-####)
    const latestOrderId = data[0].order_id
    const match = latestOrderId.match(/O-(\d+)$/)

    if (!match) {
      return {
        success: true,
        predictedOrderId: "O-0001",
      }
    }

    // Increment by 1
    const currentNum = parseInt(match[1], 10)
    const nextNum = currentNum + 1
    const predictedOrderId = `O-${String(nextNum).padStart(4, "0")}`

    return {
      success: true,
      predictedOrderId,
    }
  } catch (error) {
    return { success: false, error: "An unexpected error occurred", predictedOrderId: null }
  }
}
\`\`\`

### Client-Side Implementation

The client-side implementation in `components/new-order-sheet.tsx` handles:

1. Fetching the predicted order ID when the form opens
2. Displaying the prediction to the user
3. Logging when the form is closed without submitting

\`\`\`typescript
// State variables for order ID prediction
const [predictedOrderId, setPredictedOrderId] = useState<string>("")
const [isPredictingOrderId, setIsPredictingOrderId] = useState<boolean>(false)

// Fetch the predicted next order number
const fetchPredictedOrderNumber = async () => {
  setIsPredictingOrderId(true)
  try {
    logger.info("Fetching predicted order number for new order form")
    const result = await getPredictedNextOrderNumber()
    if (result.success && result.predictedOrderId) {
      setPredictedOrderId(result.predictedOrderId)
      logger.info(`Predicted order ID received: ${result.predictedOrderId}`)
    }
  } catch (err) {
    logger.error("Error predicting next order number:", { error: err })
  } finally {
    setIsPredictingOrderId(false)
  }
}

// Fetch the predicted order number when the form opens
useEffect(() => {
  if (open && !editOrder) {
    logger.info("New order sheet opened, fetching predicted order ID")
    fetchPredictedOrderNumber()
  }
}, [open, editOrder])

// Log when the form is closed without submitting
useEffect(() => {
  if (!open && predictedOrderId && !isSubmitting) {
    logger.info(`New order sheet closed without submitting. Predicted order ID ${predictedOrderId} was not used.`)
  }
}, [open, predictedOrderId, isSubmitting])
\`\`\`

### UI Implementation

The predicted order ID is displayed prominently in the form:

\`\`\`jsx
{!editOrder && (
  <>
    <Alert variant="info" className="mt-4">
      <Info className="h-4 w-4" />
      <AlertDescription>
        {isPredictingOrderId ? (
          "Predicting next order ID..."
        ) : predictedOrderId ? (
          <div className="text-lg font-semibold">
            Order ID: {predictedOrderId}
          </div>
        ) : (
          "Order ID will be automatically generated by the system."
        )}
      </AlertDescription>
    </Alert>
    
    {predictedOrderId && !isPredictingOrderId && (
      <p className="text-xs italic text-muted-foreground mt-1 ml-1">
        ID confirmed only on order creation
      </p>
    )}
  </>
)}
\`\`\`

## Database Implementation

The actual order ID is generated by a database trigger when an order is inserted into the database. This ensures that the official order ID is assigned in a thread-safe manner, preventing duplicate IDs even in high-concurrency scenarios.

## Benefits

This prediction-based approach offers several benefits:

1. **Improved User Experience**: Users can see the expected order ID before submitting the form
2. **No ID Gaps**: Order IDs remain sequential without gaps from abandoned forms
3. **Reduced Database Operations**: The system doesn't need to reserve and potentially roll back IDs
4. **Thread Safety**: The actual ID assignment happens in the database, ensuring uniqueness

## Logging

The system includes comprehensive logging to track:

1. When the new order form is opened
2. When a predicted order ID is fetched
3. When the form is closed without submitting (abandoned)
4. When an order is successfully created

This logging helps with debugging and monitoring the system's behavior.

## Comparison with SKU ID Generation

The Order ID Generation System uses a similar prediction-based approach as the SKU ID Generation System, but with some key differences:

1. Order IDs have a simpler format (`O-XXXX`) compared to SKU IDs
2. Order IDs are purely sequential, while SKU IDs include category codes
3. The UI presentation is tailored to the order creation workflow

Both systems share the core benefit of preventing ID gaps while providing a good user experience.
